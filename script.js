// script.js - Complete Frontend Logic for Insurance Comparison Platform

// Global State
const state = {
    uploadedFiles: [],
    isAnalyzing: false,
    currentResults: null
};

// DOM Elements
const elements = {
    // Views
    uploadView: null,
    resultsView: null,
    
    // Upload elements
    uploadBox: null,
    fileInput: null,
    fileList: null,
    analyzeBtn: null,
    
    // Results elements
    loader: null,
    resultsContent: null,
    backBtn: null,
    copyBtn: null,
    newAnalysisBtn: null,
    aiCommentary: null,
    comparisonTable: null,
    fileCount: null,
    
    // Toast container
    toastContainer: null
};

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', init);

function init() {
    console.log('üöÄ Insurance Comparison Platform initializing...');
    
    // Cache DOM elements
    cacheElements();
    
    // Setup event listeners
    setupEventListeners();
    
    // Show welcome toast
    showToast('Ho≈ü geldiniz! Poli√ßelerinizi y√ºkleyerek ba≈ülayƒ±n.', 'info');
    
    console.log('‚úÖ Platform ready!');
}

function cacheElements() {
    // Views
    elements.uploadView = document.getElementById('upload-view');
    elements.resultsView = document.getElementById('results-view');
    
    // Upload elements
    elements.uploadBox = document.getElementById('upload-box');
    elements.fileInput = document.getElementById('file-input');
    elements.fileList = document.getElementById('file-list');
    elements.analyzeBtn = document.getElementById('analyze-btn');
    
    // Results elements
    elements.loader = document.getElementById('loader');
    elements.resultsContent = document.getElementById('results-content');
    elements.backBtn = document.getElementById('back-btn');
    elements.copyBtn = document.getElementById('copy-btn');
    elements.newAnalysisBtn = document.getElementById('new-analysis-btn');
    elements.aiCommentary = document.getElementById('ai-commentary');
    elements.comparisonTable = document.getElementById('comparison-table');
    elements.fileCount = document.getElementById('file-count');
    
    // Toast container
    elements.toastContainer = document.getElementById('toast-container');
}

function setupEventListeners() {
    // File upload events
    elements.fileInput.addEventListener('change', handleFileSelect);
    
    // Drag and drop events
    setupDragAndDrop();
    
    // Button events
    elements.analyzeBtn.addEventListener('click', startAnalysis);
    elements.backBtn.addEventListener('click', goBack);
    elements.newAnalysisBtn.addEventListener('click', goBack);
    elements.copyBtn.addEventListener('click', copyResults);
    
    // Share button events
    setupShareButtons();
}

// ============= FILE UPLOAD FUNCTIONALITY =============

function setupDragAndDrop() {
    const box = elements.uploadBox;
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        box.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // Highlight drop area when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        box.addEventListener(eventName, () => box.classList.add('drag-over'), false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        box.addEventListener(eventName, () => box.classList.remove('drag-over'), false);
    });
    
    // Handle dropped files
    box.addEventListener('drop', handleDrop, false);
}

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
}

function handleFileSelect(e) {
    const files = e.target.files;
    handleFiles(files);
}

function handleFiles(files) {
    const validFiles = [];
    
    for (let file of files) {
        // Validate file
        const validation = validateFile(file);
        
        if (!validation.valid) {
            showToast(validation.message, 'error');
            continue;
        }
        
        // Check for duplicates
        if (state.uploadedFiles.some(f => f.name === file.name)) {
            showToast(`${file.name} zaten y√ºklendi`, 'warning');
            continue;
        }
        
        validFiles.push(file);
    }
    
    if (validFiles.length > 0) {
        state.uploadedFiles.push(...validFiles);
        updateFileList();
        showToast(`${validFiles.length} dosya ba≈üarƒ±yla y√ºklendi`, 'success');
    }
}

function validateFile(file) {
    // Check file type
    if (!file.type.includes('pdf')) {
        return {
            valid: false,
            message: `‚ùå ${file.name} PDF dosyasƒ± deƒüil`
        };
    }
    
    // Check file size (50MB limit)
    const maxSize = 50 * 1024 * 1024; // 50MB
    if (file.size > maxSize) {
        return {
            valid: false,
            message: `‚ùå ${file.name} √ßok b√ºy√ºk (max 50MB)`
        };
    }
    
    return { valid: true };
}

function updateFileList() {
    const list = elements.fileList;
    list.innerHTML = '';
    
    if (state.uploadedFiles.length === 0) {
        list.innerHTML = '<p class="no-files">Hen√ºz dosya y√ºklenmedi</p>';
        updateAnalyzeButton();
        return;
    }
    
    state.uploadedFiles.forEach((file, index) => {
        const fileItem = createFileItem(file, index);
        list.appendChild(fileItem);
    });
    
    updateAnalyzeButton();
}

function createFileItem(file, index) {
    const div = document.createElement('div');
    div.className = 'file-item';
    div.innerHTML = `
        <div class="file-icon">üìÑ</div>
        <div class="file-info">
            <div class="file-name">${truncateFileName(file.name, 30)}</div>
            <div class="file-size">${formatFileSize(file.size)}</div>
        </div>
        <button class="file-remove" data-index="${index}" title="Dosyayƒ± Kaldƒ±r">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    `;
    
    // Add remove event
    div.querySelector('.file-remove').addEventListener('click', () => removeFile(index));
    
    return div;
}

function removeFile(index) {
    const fileName = state.uploadedFiles[index].name;
    state.uploadedFiles.splice(index, 1);
    updateFileList();
    showToast(`${truncateFileName(fileName, 20)} kaldƒ±rƒ±ldƒ±`, 'info');
}

function updateAnalyzeButton() {
    const btn = elements.analyzeBtn;
    const btnText = btn.querySelector('.btn-text');
    const fileCount = state.uploadedFiles.length;
    
    if (fileCount < 2) {
        btn.disabled = true;
        btnText.textContent = fileCount === 0 
            ? 'En Az 2 Poli√ße Y√ºkleyin' 
            : 'En Az 1 Poli√ße Daha Y√ºkleyin';
    } else {
        btn.disabled = false;
        btnText.textContent = `${fileCount} Poli√ßeyi Kar≈üƒ±la≈ütƒ±r`;
    }
}

// ============= ANALYSIS FUNCTIONALITY =============

async function startAnalysis() {
    if (state.uploadedFiles.length < 2) {
        showToast('En az 2 poli√ße y√ºklemelisiniz!', 'error');
        return;
    }
    
    if (state.isAnalyzing) {
        showToast('Analiz devam ediyor, l√ºtfen bekleyin...', 'warning');
        return;
    }
    
    state.isAnalyzing = true;
    
    // Switch to results view
    showResultsView();
    
    // Show loader
    showLoader();
    
    // Prepare form data
    const formData = new FormData();
    state.uploadedFiles.forEach(file => {
        formData.append('files', file);
    });
    
    try {
        console.log('üì§ Sending files for analysis...');
        
        const response = await fetch('/api/analyze', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Analiz ba≈üarƒ±sƒ±z oldu');
        }
        
        const data = await response.json();
        console.log('‚úÖ Analysis complete:', data);
        
        state.currentResults = data;
        
        // Hide loader and show results
        hideLoader();
        showResults(data);
        
        showToast('üéØ Analiz ba≈üarƒ±yla tamamlandƒ±!', 'success');
        
    } catch (error) {
        console.error('‚ùå Analysis error:', error);
        
        hideLoader();
        
        // Show error message
        let errorMessage = 'Analiz sƒ±rasƒ±nda bir hata olu≈ütu.';
        
        if (error.message.includes('rate_limit')) {
            errorMessage = 'API kullanƒ±m limiti a≈üƒ±ldƒ±. L√ºtfen birka√ß dakika bekleyin.';
        } else if (error.message.includes('quota')) {
            errorMessage = 'API kotasƒ± doldu. L√ºtfen y√∂neticiyle ileti≈üime ge√ßin.';
        } else if (error.message.includes('timeout')) {
            errorMessage = 'ƒ∞≈ülem zaman a≈üƒ±mƒ±na uƒüradƒ±. Daha k√º√ß√ºk dosyalar deneyin.';
        } else if (error.message) {
            errorMessage = error.message;
        }
        
        showToast(`‚ùå ${errorMessage}`, 'error');
        
        // Go back after 3 seconds
        setTimeout(goBack, 3000);
        
    } finally {
        state.isAnalyzing = false;
    }
}

function showLoader() {
    elements.loader.classList.remove('hidden');
    elements.resultsContent.classList.add('hidden');
    
    // Animate progress bar
    const progressBar = elements.loader.querySelector('.progress-bar');
    progressBar.style.width = '0%';
    
    setTimeout(() => {
        progressBar.style.width = '30%';
    }, 500);
    
    setTimeout(() => {
        progressBar.style.width = '60%';
    }, 2000);
    
    setTimeout(() => {
        progressBar.style.width = '90%';
    }, 4000);
}

function hideLoader() {
    elements.loader.classList.add('hidden');
    
    // Complete progress bar
    const progressBar = elements.loader.querySelector('.progress-bar');
    progressBar.style.width = '100%';
}

function showResults(data) {
    // Update file count
    elements.fileCount.textContent = state.uploadedFiles.length;
    
    // Display AI commentary
    displayCommentary(data.aiCommentary);
    
    // Display comparison table
    displayTable(data.tableHtml);
    
    // Show results content
    elements.resultsContent.classList.remove('hidden');
    
    // Scroll to top
    elements.resultsView.scrollTop = 0;
}

function displayCommentary(commentary) {
    if (!commentary) {
        elements.aiCommentary.innerHTML = '<p>Yorum olu≈üturulamadƒ±.</p>';
        return;
    }
    
    // Format commentary with proper paragraphs
    const formattedCommentary = commentary
        .split('\n\n')
        .map(paragraph => `<p>${paragraph.trim()}</p>`)
        .join('');
    
    elements.aiCommentary.innerHTML = formattedCommentary;
    
    // Add animation
    elements.aiCommentary.style.opacity = '0';
    setTimeout(() => {
        elements.aiCommentary.style.opacity = '1';
    }, 100);
}

function displayTable(tableHtml) {
    if (!tableHtml) {
        elements.comparisonTable.innerHTML = `
            <tbody>
                <tr>
                    <td colspan="3" style="text-align: center; padding: 2rem;">
                        Kar≈üƒ±la≈ütƒ±rma tablosu olu≈üturulamadƒ±.
                    </td>
                </tr>
            </tbody>
        `;
        return;
    }
    
    elements.comparisonTable.innerHTML = tableHtml;
    
    // Add hover effects to table rows
    const rows = elements.comparisonTable.querySelectorAll('tbody tr');
    rows.forEach(row => {
        row.addEventListener('mouseenter', () => {
            row.style.background = 'rgba(59, 130, 246, 0.05)';
        });
        row.addEventListener('mouseleave', () => {
            row.style.background = '';
        });
    });
}

// ============= RESULTS ACTIONS =============

function copyResults() {
    try {
        // Get commentary text
        const commentary = elements.aiCommentary.innerText || 'Yorum yok';
        
        // Get table text
        let tableText = '';
        const table = elements.comparisonTable;
        
        if (table.rows.length > 0) {
            for (let row of table.rows) {
                const cells = Array.from(row.cells).map(cell => cell.innerText.trim());
                tableText += cells.join(' | ') + '\n';
            }
        }
        
        // Combine all text
        const fullText = `
üõ°Ô∏è Sƒ∞GORTA KAR≈ûILA≈ûTIRMA ANALƒ∞Zƒ∞
${'='.repeat(50)}

üéØ UZMAN ANALƒ∞Zƒ∞ VE TAVSƒ∞YE
${'='.repeat(50)}
${commentary}

üìä DETAYLI KAR≈ûILA≈ûTIRMA TABLOSU
${'='.repeat(50)}
${tableText}

${'='.repeat(50)}
üìÖ Analiz Tarihi: ${new Date().toLocaleDateString('tr-TR')}
üöÄ Sigorta Kar≈üƒ±la≈ütƒ±rma Platformu
Created by Murat √ñzg√ºr √únal
        `.trim();
        
        // Copy to clipboard
        navigator.clipboard.writeText(fullText).then(() => {
            // Success feedback
            const btn = elements.copyBtn;
            const originalText = btn.querySelector('.btn-text').textContent;
            
            btn.classList.add('copied');
            btn.querySelector('.btn-text').textContent = '‚úÖ Kopyalandƒ±!';
            
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.querySelector('.btn-text').textContent = originalText;
            }, 2000);
            
            showToast('üìã Analiz panoya kopyalandƒ±!', 'success');
            
        }).catch(err => {
            console.error('Copy failed:', err);
            showToast('‚ùå Kopyalama ba≈üarƒ±sƒ±z oldu', 'error');
        });
        
    } catch (error) {
        console.error('Copy error:', error);
        showToast('‚ùå Bir hata olu≈ütu', 'error');
    }
}

function setupShareButtons() {
    // WhatsApp share
    const whatsappBtn = document.querySelector('.share-btn.whatsapp');
    if (whatsappBtn) {
        whatsappBtn.addEventListener('click', () => {
            const text = encodeURIComponent('Sigorta poli√ße kar≈üƒ±la≈ütƒ±rma analizimi tamamladƒ±m. Detaylarƒ± sizinle payla≈ümak isterim.');
            window.open(`https://wa.me/?text=${text}`, '_blank');
        });
    }
    
    // Email share
    const emailBtn = document.querySelector('.share-btn.email');
    if (emailBtn) {
        emailBtn.addEventListener('click', () => {
            const subject = encodeURIComponent('Sigorta Kar≈üƒ±la≈ütƒ±rma Analizi');
            const body = encodeURIComponent('Merhaba,\n\nSigorta poli√ße kar≈üƒ±la≈ütƒ±rma analizimi tamamladƒ±m. Detaylarƒ± ektedir.\n\nSaygƒ±larƒ±mla');
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        });
    }
    
    // Telegram share
    const telegramBtn = document.querySelector('.share-btn.telegram');
    if (telegramBtn) {
        telegramBtn.addEventListener('click', () => {
            const text = encodeURIComponent('Sigorta poli√ße kar≈üƒ±la≈ütƒ±rma analizimi tamamladƒ±m.');
            window.open(`https://t.me/share/url?text=${text}`, '_blank');
        });
    }
}

// ============= VIEW MANAGEMENT =============

function showResultsView() {
    elements.uploadView.classList.remove('active');
    elements.resultsView.classList.add('active');
}

function hideResultsView() {
    elements.resultsView.classList.remove('active');
    elements.uploadView.classList.add('active');
}

function goBack() {
    // Hide results view
    hideResultsView();
    
    // Reset state
    state.uploadedFiles = [];
    state.currentResults = null;
    
    // Clear file input
    elements.fileInput.value = '';
    
    // Update UI
    updateFileList();
    
    // Reset results
    elements.aiCommentary.innerHTML = '';
    elements.comparisonTable.innerHTML = '';
    
    showToast('üîÑ Yeni analiz i√ßin hazƒ±r', 'info');
}

// ============= UTILITY FUNCTIONS =============

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function truncateFileName(name, maxLength) {
    if (name.length <= maxLength) return name;
    
    const extension = name.split('.').pop();
    const nameWithoutExt = name.slice(0, name.lastIndexOf('.'));
    const truncatedName = nameWithoutExt.slice(0, maxLength - extension.length - 4);
    
    return `${truncatedName}...${extension}`;
}

// ============= TOAST NOTIFICATIONS =============

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    // Add icon based on type
    const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
    };
    
    toast.innerHTML = `
        <span class="toast-icon">${icons[type]}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close">√ó</button>
    `;
    
    // Add to container
    elements.toastContainer.appendChild(toast);
    
    // Add close functionality
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.addEventListener('click', () => removeToast(toast));
    
    // Animate in
    setTimeout(() => toast.classList.add('show'), 10);
    
    // Auto remove after 5 seconds
    setTimeout(() => removeToast(toast), 5000);
}

function removeToast(toast) {
    toast.classList.remove('show');
    setTimeout(() => {
        if (toast.parentElement) {
            toast.parentElement.removeChild(toast);
        }
    }, 300);
}

// ============= ERROR HANDLING =============

window.addEventListener('error', (e) => {
    console.error('Global error:', e);
    showToast('Beklenmeyen bir hata olu≈ütu', 'error');
});

window.addEventListener('unhandledrejection', (e) => {
    console.error('Unhandled promise rejection:', e);
    showToast('Bir i≈ülem ba≈üarƒ±sƒ±z oldu', 'error');
});

// ============= PERFORMANCE MONITORING =============

if (window.performance) {
    window.addEventListener('load', () => {
        const perfData = window.performance.timing;
        const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
        console.log(`üìä Page load time: ${pageLoadTime}ms`);
    });
}

// ============= KEYBOARD SHORTCUTS =============

document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + O: Open file dialog
    if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
        e.preventDefault();
        elements.fileInput.click();
    }
    
    // Escape: Go back to upload view
    if (e.key === 'Escape' && elements.resultsView.classList.contains('active')) {
        goBack();
    }
    
    // Ctrl/Cmd + C: Copy results (when in results view)
    if ((e.ctrlKey || e.metaKey) && e.key === 'c' && elements.resultsView.classList.contains('active')) {
        if (!window.getSelection().toString()) {
            e.preventDefault();
            copyResults();
        }
    }
});

// ============= RESPONSIVE HANDLING =============

let resizeTimeout;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
        // Handle responsive adjustments if needed
        console.log('Window resized');
    }, 250);
});

// ============= VISIBILITY CHANGE HANDLING =============

document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        console.log('Page is hidden');
    } else {
        console.log('Page is visible');
    }
});

// ============= NETWORK STATUS =============

window.addEventListener('online', () => {
    showToast('ƒ∞nternet baƒülantƒ±sƒ± yeniden kuruldu', 'success');
});

window.addEventListener('offline', () => {
    showToast('ƒ∞nternet baƒülantƒ±sƒ± kesildi', 'error');
});

// ============= INITIALIZATION COMPLETE =============

console.log('üéØ Insurance Comparison Platform v1.0.0');
console.log('üë®‚Äçüíª Created by Murat √ñzg√ºr √únal');
console.log('üöÄ Ready for analysis!');